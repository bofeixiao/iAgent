# iData AI 平台 - Nginx 配置文件

# ===== HTTP 重定向到 HTTPS (生产环境推荐启用)
# server {
#     listen 80;
#     server_name your-domain.com;
#     return 301 https://$server_name$request_uri;
# }

# ===== HTTP 服务(开发/测试环境)
server {
    listen 80 default_server;
    server_name _;
    
    # 前端静态文件
    location / {
        root /home/xiaobofei/apps/idata-ai-platform/frontend/dist;
        index index.html;
        try_files $uri $uri/ /index.html;
        
        # 缓存策略
        location ~* (\.js|\.css|\.png|\.jpg|\.jpeg|\.gif|\.ico|\.svg|\.woff|\.woff2)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
    
    # ===== API 代理配置 =====
    
    # 认证服务
    location /api/auth/ {
        proxy_pass http://localhost:8081/api/auth/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }
    
    # 系统管理服务
    location /api/user/ {
        proxy_pass http://localhost:8082/api/user/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    # 应用及实例服务
    location /api/application/ {
        proxy_pass http://localhost:8083/api/application/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    location /api/instance/ {
        proxy_pass http://localhost:8083/api/instance/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    # 内容服务
    location /api/article/ {
        proxy_pass http://localhost:8084/api/article/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    location /api/thinking/ {
        proxy_pass http://localhost:8084/api/thinking/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    # 支付服务
    location /api/order/ {
        proxy_pass http://localhost:8085/api/order/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    location /api/credit/ {
        proxy_pass http://localhost:8085/api/credit/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    # 营销服务
    location /api/trending/ {
        proxy_pass http://localhost:8087/api/trending/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    location /api/invitation/ {
        proxy_pass http://localhost:8087/api/invitation/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    # ===== 日志配置 =====
    access_log /home/xiaobofei/apps/idata-ai-platform/logs/nginx-access.log;
    error_log /home/xiaobofei/apps/idata-ai-platform/logs/nginx-error.log warn;
    
    # ===== 性能优化 =====
    gzip on;
    gzip_types text/plain text/css text/javascript application/json application/javascript text/xml application/xml application/xml+rss;
    gzip_min_length 1000;
    gzip_comp_level 6;
    gzip_buffers 16 8k;
    
    # 请求头大小限制
    client_max_body_size 100m;
}
