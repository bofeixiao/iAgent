# iData AI创作平台 - 技术架构设计

## 1. 总体架构

### 1.1 架构风格
采用**前后端分离**的**三层架构**,结合**微服务理念**设计:

```
┌──────────────────────────────────────────────┐
│              前端层 (Presentation)            │
│         Vue 3 + Element Plus + Vite          │
└──────────────────┬───────────────────────────┘
                   │ HTTP/HTTPS
                   │ RESTful API
┌──────────────────▼───────────────────────────┐
│                 Nginx                        │
│          (反向代理 + 静态资源)                 │
└──────────────────┬───────────────────────────┘
                   │
       ┌───────────┴───────────┐
       │                       │
┌──────▼──────┐       ┌────────▼────────┐
│  应用服务器  │       │   应用服务器     │
│  (可扩展)   │       │   (负载均衡)     │
└──────┬──────┘       └────────┬────────┘
       │                       │
       └───────────┬───────────┘
                   │
┌──────────────────▼───────────────────────────┐
│              业务逻辑层 (Business)             │
│      Spring Boot 3.x + Spring Cloud          │
│  ┌──────────┬──────────┬──────────────────┐  │
│  │ 用户服务  │ 应用服务  │ AI调用服务        │  │
│  └──────────┴──────────┴──────────────────┘  │
└──────────────────┬───────────────────────────┘
                   │
       ┌───────────┼───────────┐
       │           │           │
┌──────▼──────┐ ┌──▼───┐ ┌────▼─────┐
│   MySQL     │ │Redis │ │ RabbitMQ │
│  (主从)     │ │(缓存)│ │ (消息队列)│
└─────────────┘ └──────┘ └──────────┘
```

### 1.2 技术选型总览

| 层次 | 技术栈 | 版本 | 说明 |
|-----|--------|------|------|
| **前端** | Vue.js | 3.4+ | 渐进式JavaScript框架 |
| | Element Plus | 2.5+ | Vue 3组件库 |
| | Vite | 5.x | 前端构建工具 |
| | Pinia | 2.x | 状态管理 |
| | Vue Router | 4.x | 路由管理 |
| | Axios | 1.6+ | HTTP客户端 |
| | TypeScript | 5.x | 类型安全 |
| **后端** | Java | 17 LTS | JDK版本 |
| | Spring Boot | 3.2.x | 应用框架 |
| | Spring Security | 6.x | 安全框架 |
| | Spring Data JPA | 3.2.x | ORM框架 |
| | MyBatis Plus | 3.5+ | 持久层增强 |
| | Spring Cloud Gateway | 4.x | API网关 |
| **数据库** | MySQL | 8.0+ | 关系型数据库 |
| | Redis | 7.x | 缓存数据库 |
| **消息队列** | RabbitMQ | 3.12+ | 消息中间件 |
| **工具** | Maven | 3.9+ | 项目构建 |
| | Lombok | 1.18+ | 代码简化 |
| | Swagger/OpenAPI | 3.0 | API文档 |
| | JWT | 0.11+ | Token认证 |
| | Hutool | 5.8+ | Java工具库 |
| **部署** | Docker | 24.x | 容器化 |
| | Docker Compose | 2.x | 容器编排 |
| | Nginx | 1.24+ | Web服务器 |

## 2. 后端技术架构

### 2.1 项目结构设计

```
idata-ai-platform/
├── idata-common/          # 公共模块
│   ├── common-core/       # 核心工具类、常量
│   ├── common-security/   # 安全认证公共模块
│   ├── common-redis/      # Redis公共模块
│   └── common-web/        # Web公共配置
├── idata-gateway/         # API网关
├── idata-auth/            # 认证授权服务
├── idata-system/          # 系统管理服务
│   └── 用户管理、角色权限等
├── idata-app/             # 应用服务
│   └── 应用模板、应用实例管理
├── idata-content/         # 内容服务
│   └── 文章、思维、作品管理
├── idata-payment/         # 支付服务
│   └── 会员、积分、订单管理
├── idata-ai/              # AI调用服务
│   └── AI接口封装、异步处理
└── idata-marketing/       # 营销服务
    └── 活动、优惠券、邀请管理
```

### 2.2 Spring Boot 分层架构

```
com.idataai.{module}/
├── controller/            # 控制层 - REST API
├── service/              # 服务层 - 业务逻辑
│   ├── impl/
├── mapper/               # 持久层 - MyBatis Mapper
├── domain/               # 领域模型
│   ├── entity/           # 实体类 (对应数据库表)
│   ├── dto/              # 数据传输对象
│   └── vo/               # 视图对象
├── config/               # 配置类
├── aspect/               # AOP切面
├── exception/            # 异常处理
├── utils/                # 工具类
└── constants/            # 常量定义
```

### 2.3 核心技术实现

#### 2.3.1 认证授权 (Spring Security + JWT)
```java
// 配置示例
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) {
        http.csrf().disable()
            .sessionManagement()
                .sessionCreationPolicy(SessionCreationPolicy.STATELESS)
            .and()
            .authorizeHttpRequests()
                .requestMatchers("/api/v1/auth/**").permitAll()
                .anyRequest().authenticated()
            .and()
            .addFilterBefore(jwtAuthFilter, 
                UsernamePasswordAuthenticationFilter.class);
        return http.build();
    }
}
```

#### 2.3.2 数据库访问 (MyBatis Plus)
```java
// Entity
@Data
@TableName("t_user")
public class User {
    @TableId(type = IdType.ASSIGN_ID)
    private Long id;
    private String username;
    private String email;
    private String phone;
    @TableField(fill = FieldFill.INSERT)
    private LocalDateTime createTime;
}

// Mapper
@Mapper
public interface UserMapper extends BaseMapper<User> {
    // 自定义查询
    IPage<User> selectUserPage(Page<User> page, 
        @Param("query") UserQueryDto query);
}

// Service
@Service
public class UserServiceImpl extends 
    ServiceImpl<UserMapper, User> implements IUserService {
    // 业务逻辑
}
```

#### 2.3.3 Redis缓存
```java
@Configuration
@EnableCaching
public class RedisConfig {
    
    @Bean
    public RedisTemplate<String, Object> redisTemplate(
        RedisConnectionFactory factory) {
        RedisTemplate<String, Object> template = new RedisTemplate<>();
        template.setConnectionFactory(factory);
        template.setKeySerializer(new StringRedisSerializer());
        template.setValueSerializer(new GenericJackson2JsonRedisSerializer());
        return template;
    }
}

// 使用示例
@Service
public class ApplicationService {
    
    @Cacheable(value = "applications", key = "#id")
    public Application getById(Long id) {
        return applicationMapper.selectById(id);
    }
    
    @CacheEvict(value = "applications", key = "#id")
    public void deleteById(Long id) {
        applicationMapper.deleteById(id);
    }
}
```

#### 2.3.4 异步处理 (RabbitMQ + @Async)
```java
// 配置
@Configuration
public class RabbitMQConfig {
    
    @Bean
    public Queue aiTaskQueue() {
        return new Queue("ai.task.queue", true);
    }
    
    @Bean
    public DirectExchange aiExchange() {
        return new DirectExchange("ai.exchange");
    }
    
    @Bean
    public Binding binding() {
        return BindingBuilder.bind(aiTaskQueue())
            .to(aiExchange()).with("ai.task");
    }
}

// 生产者
@Service
public class InstanceService {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    public void createInstance(CreateInstanceDto dto) {
        // 创建实例记录
        Instance instance = saveInstance(dto);
        // 发送到MQ异步处理
        rabbitTemplate.convertAndSend("ai.exchange", 
            "ai.task", instance.getId());
    }
}

// 消费者
@Component
public class AITaskConsumer {
    
    @RabbitListener(queues = "ai.task.queue")
    public void processAITask(Long instanceId) {
        // 调用AI接口处理
        aiService.process(instanceId);
    }
}
```

#### 2.3.5 异常处理
```java
@RestControllerAdvice
public class GlobalExceptionHandler {
    
    @ExceptionHandler(BusinessException.class)
    public Result<?> handleBusinessException(BusinessException e) {
        return Result.error(e.getCode(), e.getMessage());
    }
    
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public Result<?> handleValidException(
        MethodArgumentNotValidException e) {
        String message = e.getBindingResult()
            .getFieldError().getDefaultMessage();
        return Result.error(400, message);
    }
}
```

## 3. 前端技术架构

### 3.1 项目结构

```
idata-ai-platform-web/
├── public/                # 静态资源
│   └── favicon.ico
├── src/
│   ├── assets/           # 资源文件(图片、样式)
│   ├── components/       # 公共组件
│   │   ├── common/       # 通用组件
│   │   └── business/     # 业务组件
│   ├── views/            # 页面组件
│   │   ├── auth/         # 认证页面
│   │   ├── application/  # 应用中心
│   │   ├── instance/     # 作品管理
│   │   ├── thinking/     # 思维系统
│   │   ├── article/      # 精华内容
│   │   └── user/         # 用户中心
│   ├── router/           # 路由配置
│   ├── stores/           # Pinia状态管理
│   ├── api/              # API接口封装
│   ├── utils/            # 工具函数
│   ├── types/            # TypeScript类型定义
│   ├── directives/       # 自定义指令
│   ├── styles/           # 全局样式
│   ├── App.vue           # 根组件
│   └── main.ts           # 入口文件
├── .env.development      # 开发环境变量
├── .env.production       # 生产环境变量
├── vite.config.ts        # Vite配置
├── tsconfig.json         # TypeScript配置
└── package.json
```

### 3.2 状态管理 (Pinia)

```typescript
// stores/user.ts
import { defineStore } from 'pinia'

export const useUserStore = defineStore('user', {
  state: () => ({
    token: '',
    userInfo: null as UserInfo | null,
    vipLevel: 0,
    credits: 0
  }),
  
  getters: {
    isLogin: (state) => !!state.token,
    isVIP: (state) => state.vipLevel > 0
  },
  
  actions: {
    async login(credentials: LoginDto) {
      const { data } = await authApi.login(credentials)
      this.token = data.token
      this.userInfo = data.userInfo
      localStorage.setItem('token', data.token)
    },
    
    logout() {
      this.token = ''
      this.userInfo = null
      localStorage.removeItem('token')
    }
  }
})
```

### 3.3 路由配置

```typescript
// router/index.ts
import { createRouter, createWebHistory } from 'vue-router'

const routes = [
  {
    path: '/',
    component: () => import('@/views/layout/MainLayout.vue'),
    children: [
      {
        path: '',
        redirect: '/applications'
      },
      {
        path: 'applications',
        name: 'Applications',
        component: () => import('@/views/application/ApplicationList.vue'),
        meta: { title: '应用中心' }
      },
      {
        path: 'instances',
        name: 'Instances',
        component: () => import('@/views/instance/InstanceList.vue'),
        meta: { title: '我的作品', requiresAuth: true }
      },
      // ... 其他路由
    ]
  },
  {
    path: '/login',
    component: () => import('@/views/auth/Login.vue')
  }
]

const router = createRouter({
  history: createWebHistory(),
  routes
})

// 路由守卫
router.beforeEach((to, from, next) => {
  const userStore = useUserStore()
  if (to.meta.requiresAuth && !userStore.isLogin) {
    next('/login')
  } else {
    next()
  }
})
```

### 3.4 API封装

```typescript
// api/request.ts
import axios from 'axios'
import { useUserStore } from '@/stores/user'

const request = axios.create({
  baseURL: import.meta.env.VITE_API_BASE_URL,
  timeout: 30000
})

// 请求拦截器
request.interceptors.request.use(
  config => {
    const userStore = useUserStore()
    if (userStore.token) {
      config.headers['Authorization'] = `Bearer ${userStore.token}`
    }
    return config
  },
  error => Promise.reject(error)
)

// 响应拦截器
request.interceptors.response.use(
  response => response.data,
  error => {
    if (error.response?.status === 401) {
      const userStore = useUserStore()
      userStore.logout()
      router.push('/login')
    }
    return Promise.reject(error)
  }
)

// api/application.ts
export const applicationApi = {
  getList: (params: ApplicationQueryDto) =>
    request.get('/api/v1/applications', { params }),
    
  getById: (id: number) =>
    request.get(`/api/v1/applications/${id}`),
    
  create: (data: CreateInstanceDto) =>
    request.post('/api/v1/instances/create', data)
}
```

## 4. 数据库设计

### 4.1 数据库选型
- **主库**: MySQL 8.0 (InnoDB引擎)
- **缓存**: Redis 7.x
- **索引**: 合理使用B+Tree索引

### 4.2 核心表设计

详见独立文档: `03-数据库设计.md`

### 4.3 数据库优化策略
- 读写分离(主从复制)
- 分库分表(ShardingSphere)
- 合理建立索引
- 慢查询优化
- 连接池配置(HikariCP)

## 5. 性能优化策略

### 5.1 后端优化
1. **缓存策略**
   - Redis缓存热点数据(应用列表、用户信息)
   - 本地缓存(Caffeine)
   - 缓存更新策略(Cache-Aside)

2. **数据库优化**
   - 索引优化
   - 分页查询
   - 批量操作
   - 连接池调优

3. **异步处理**
   - AI任务异步化(RabbitMQ)
   - @Async注解异步方法
   - CompletableFuture

4. **接口优化**
   - 数据分页
   - 字段裁剪
   - GZIP压缩

### 5.2 前端优化
1. **构建优化**
   - 代码分割(Vite自动)
   - Tree Shaking
   - 资源压缩

2. **运行时优化**
   - 路由懒加载
   - 组件懒加载
   - 图片懒加载
   - 虚拟滚动(大列表)

3. **缓存策略**
   - 静态资源CDN
   - 浏览器缓存
   - LocalStorage/SessionStorage

### 5.3 并发支持
为支持1000并发:
- **应用服务器**: 至少2台(负载均衡)
- **数据库**: 主从架构
- **Redis**: 主从+哨兵
- **JVM参数调优**: -Xms2g -Xmx2g
- **Nginx**: worker_processes auto; worker_connections 2048;
- **连接池**: maximumPoolSize=50

## 6. 安全设计

### 6.1 认证授权
- JWT Token认证
- Token过期刷新机制
- 基于RBAC的权限控制

### 6.2 数据安全
- 密码BCrypt加密存储
- 敏感信息AES加密
- HTTPS传输加密
- SQL注入防护(MyBatis预编译)
- XSS防护(前端转义 + 后端过滤)
- CSRF防护(Token验证)

### 6.3 接口安全
- 接口限流(Sentinel/Redis)
- 参数校验(Hibernate Validator)
- 接口签名
- IP白名单(敏感接口)

## 7. 部署架构

### 7.1 Docker容器化部署

```yaml
# docker-compose.yml
version: '3.8'
services:
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: idataai2026
      MYSQL_DATABASE: idata_ai
    volumes:
      - mysql-data:/var/lib/mysql
    ports:
      - "3306:3306"
  
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
  
  rabbitmq:
    image: rabbitmq:3.12-management
    ports:
      - "5672:5672"
      - "15672:15672"
  
  gateway:
    build: ./idata-gateway
    ports:
      - "8080:8080"
    depends_on:
      - mysql
      - redis
  
  app-service:
    build: ./idata-app
    deploy:
      replicas: 2
    depends_on:
      - mysql
      - redis
      - rabbitmq
  
  nginx:
    image: nginx:1.24-alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./dist:/usr/share/nginx/html
    depends_on:
      - gateway

volumes:
  mysql-data:
```

### 7.2 生产环境部署
- **负载均衡**: Nginx
- **应用服务**: 多实例部署
- **数据库**: 主从复制
- **缓存**: Redis Sentinel
- **监控**: Prometheus + Grafana
- **日志**: ELK Stack

## 8. 开发规范

### 8.1 代码规范
- **Java**: 阿里巴巴Java开发手册
- **前端**: ESLint + Prettier
- **Git**: Conventional Commits

### 8.2 接口规范
- RESTful API设计规范
- 统一响应格式
- 统一异常处理
- Swagger/OpenAPI文档

### 8.3 数据库规范
- 表名: t_{module}_{table}
- 字段名: 下划线命名
- 主键: id (BIGINT)
- 必备字段: create_time, update_time, is_deleted

---

**文档版本**: v1.0  
**编制日期**: 2026-02-15  
**编制人**: iDataAI团队
